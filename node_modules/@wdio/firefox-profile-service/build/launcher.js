"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _firefoxProfile = _interopRequireDefault(require("firefox-profile"));

var _util = require("util");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class FirefoxProfileLauncher {
  constructor(options) {
    this.options = options;
  }

  async onPrepare(config, capabilities) {
    var _context;

    if (Object.keys(this.options).length === 0) {
      return;
    }

    if (this.options.profileDirectory) {
      this.profile = await (0, _util.promisify)(_firefoxProfile.default.copy)(this.options.profileDirectory);
    } else {
      this.profile = new _firefoxProfile.default();
    }

    this._setPreferences();

    if (!Array.isArray(this.options.extensions)) {
      return this._buildExtension(capabilities);
    }

    await (0, _util.promisify)((_context = this.profile).addExtensions.bind(_context))(this.options.extensions);
    return this._buildExtension(capabilities);
  }

  _setPreferences() {
    for (const [preference, value] of Object.entries(this.options)) {
      if (['extensions', 'proxy', 'legacy', 'profileDirectory'].includes(preference)) {
        continue;
      }

      this.profile.setPreference(preference, value);
    }

    if (this.options.proxy) {
      this.profile.setProxy(this.options.proxy);
    }

    this.profile.updatePreferences();
  }

  async _buildExtension(capabilities) {
    var _context2;

    const zippedProfile = await (0, _util.promisify)((_context2 = this.profile).encoded.bind(_context2))();

    if (Array.isArray(capabilities)) {
      capabilities.filter(capability => capability.browserName === 'firefox').forEach(capability => {
        this._setProfile(capability, zippedProfile);
      });
      return;
    }

    for (const browser in capabilities) {
      const capability = capabilities[browser].capabilities;

      if (!capability || capability.browserName !== 'firefox') {
        continue;
      }

      this._setProfile(capability, zippedProfile);
    }
  }

  _setProfile(capability, zippedProfile) {
    if (this.options.legacy) {
      capability.firefox_profile = zippedProfile;
    } else {
      capability['moz:firefoxOptions'] = capability['moz:firefoxOptions'] || {};
      capability['moz:firefoxOptions'].profile = zippedProfile;
    }
  }

}

exports.default = FirefoxProfileLauncher;